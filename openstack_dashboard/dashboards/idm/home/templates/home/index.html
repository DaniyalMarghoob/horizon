{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Home" %}{% endblock %}

{% block page_header %}
  {% include "horizon/common/_domain_page_header.html" with title="Home" %}
{% endblock page_header %}

{% block main %}
  <div id="home">
	{{ applications_table.render}}
	
	{{ organizations_table.render }}          
  </div>
  <script type="text/javascript">
	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie != '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) == (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	};

	function csrfSafeMethod(method) {
		// these HTTP methods do not require CSRF protection
		return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
	}

	var csrftoken = getCookie('csrftoken');

	// AJAX setup functions
	var beforeSend = function(xhr, settings) {
		if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
			xhr.setRequestHeader("X-CSRFToken", csrftoken);
		}
	};
	var error = function(jqXHR, status, errorThrown) {
		if (jqXHR.status === 401){
			var redir_url = jqXHR.getResponseHeader("X-Horizon-Location");
			if (redir_url){
				location.href = redir_url;
			} else {
				location.reload(true);
			}
		}
		else {
			if (!horizon.ajax.get_messages(jqXHR)) {
				// Generic error handler. Really generic.
				horizon.alert("danger", gettext("An error occurred. Please try again later."));
			}
		}
	};

	$( document ).ready(function() {
		var initTour = new Tour({
			name: "getStartedTour",
			debug: false,
			backdrop: true,
			template: function() {
				return tourTemplate.replace(/tourName/g, 'initTour');
			},
			onEnd: function() {
				$.ajax({
					type: "POST",
					url: "{% url 'horizon:idm:users:tour_ended' request.user.id %}",
					data: "Tour ended",
					dataType: 'html',
					beforeSend: beforeSend,
					error: error
				});
			},
			steps: [
			{
				title: "Let's get started!",
				content: "Welcome to the FIWARE's KeyRock IdM. This is a basic tour that will show you the basics.",
				orphan: true
			},
			{
				title: "FIWARE Portal",
				content: "The FIWARE's IdM is part of FIWARE Lab. You an check the other FIWARE lab components in this bar.",
				orphan: true
			},
			{
				element: "#applications",
				title: "Applications", 
				content: "This is the applications table",
				placement: "right"
			},
			{
				element: "#organizations",
				title: "Organizations", 
				content: "This is this the organizations table",
				placement: "left"
			}, 
			{
				title: "Initial tour finished!",
				content: "You have finished the basic tour. Click <span data-next-tour='appsTour'>here</span> to start learning to register your applications or click 'End tour' to exit the tour",
				orphan: true
			},
			]
		});
		if ({% if request.user.starters_tour_ended %}false{% else %}true{% endif %}) {
			initTour.init();
			initTour.start();
		}
	});
  </script>
{% endblock %}




