{% extends 'base.html' %}
{% load i18n %}
{% block title %}{% trans "Applications" %}{% endblock %}

{% block page_header %}{% endblock page_header %}

{% block main %}
<div id="detailApplication">
  <header>
    <h4 class="name">
      {{ application.name }}
      {% if edit %}
      <a href="{% url 'horizon:idm:myApplications:edit' application.id %}" class="small"><i class="fa fa-edit"></i><span>edit</span></a>
      {% endif %}
      {% if manage_roles %}
      <a href="{% url 'horizon:idm:myApplications:roles_manage' application.id %}" class="small"><i class="fa fa-cogs"></i><span>manage roles</span></a>
      {% endif %}
    </h4>
    <div class="logo">
      <img alt="application logo" src="{{ image }}">
    </div>
  </header>
  <div class="panel panel-default info">
    <div class="panel-body">
      <div class="description">
        <h5>
          Description
        </h5>

        <div class="info expander">
            {% if application.description %}
          <p>{{ application.description }}</p>
          {% else %}
          <p><i>No description available</i></p>
          {% endif %}
        </div>
      </div>

      <div class="url">
        <h5>URL</h5>
        <p>{{ application.url }}</p>
      </div>
      <div class="callback_url">
        <h5>Callback URL</h5>
        <p>{{ application.redirect_uris.0 }}</p>
      </div>
      {% if viewCred %}
        <div class="extra">
          <h4 class="panel-title">
            <a data-toggle="collapse" href="#collapse_pep_proxy" aria-expanded="true" aria-controls="collapse_pep_proxy">
              PEP Proxy
            </a>
          </h4>
          <div id="collapse_pep_proxy" class="form-group collapse {% if pep_proxy_password %}in{% endif %}" role="tabpanel">
            {% if application.pep_proxy_name %}
              <div>
                <h6 class="panel-heading">Username</h6>
                <p>{{ application.pep_proxy_name }}</p>
                {% if pep_proxy_password %}
                  <h6 class="panel-heading">Password</h6>
                  <p class="info">{{ pep_proxy_password }}</p>
                {% endif %}
                <a href="{% url 'horizon:idm:myApplications:reset_password_pep' application.id %}" class="btn btn-default">Reset password</a>
                <a href="{% url 'horizon:idm:myApplications:delete_pep' application.id %}" class="btn btn-danger">Delete PEP Proxy</a>
              </div>
            {% else %}
              <h6 class="panel-heading"></h6>
              <a href="{% url 'horizon:idm:myApplications:register_pep' application.id %}" class="btn btn-default">Register a new PEP Proxy</a>
            {% endif %}
          </div>
        </div>
        <div class="extra">
          <h4 class="panel-title">
            <a data-toggle="collapse" href="#collapse_oauth2_credentials" aria-expanded="true" aria-controls="collapse_oauth2_credentials">
              OAuth2 Credentials
            </a>
          </h4>
          <div id="collapse_oauth2_credentials" class="form-group collapse" role="tabpanel">
            <div>
              <h6 class="panel-heading">Client ID</h6>
              <p>{{ application.id }}</p>
            </div>
            <div>
              <h6 class="panel-heading">Client Secret</h6>
              <p>{{ application.secret }}</p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="panel panel-default members" id="{{ auth_users_table.slugify_name }}">
    <div class="panel-heading">
      <span>{{ auth_users_table }}</span>
      {{ auth_users_table.render_table_actions }}
    </div>
    <div class="panel-body">
      {% if auth_users_table.get_rows %}
      {{ auth_users_table.render}}
      {% else %}
      <p class="alert alert-info empty">{{ application.name }} does not have any authorized users.</p>
      {% endif %}
    </div>
    <div class="panel-footer">
      <nav id="{{auth_users_table.slugify_name}}_pagination_container">
      </nav>
    </div>
  </div>

  <script>
    $(document).ready(function(){
      // init bootpag
      $('#{{ auth_users_table.slugify_name }}_pagination_container').bootpag({
          total: {{ auth_users_table.indexes|length }}
      }).on("page", function(event, num){
           $("#{{ auth_users_table.slugify_name }} > div.panel-body").html("Insert content"); // some ajax content loading...
      });
    });
  </script>

  <div class="panel panel-default organizations" id="{{ organizations_table.slugify_name }}">
    <div class="panel-heading">
      <span>{{ organizations_table }}</span>
      {{ organizations_table.render_table_actions }}
    </div>
    <div class="panel-body">
      {% if organizations_table.get_rows %}
      {{ organizations_table.render}}
      {% else %}
      <p class="alert alert-info empty">{{ application.name }} does not have any authorized organizations.</p>
      {% endif %}
    </div>
    <div class="panel-footer">
      <nav id="{{organizations_table.slugify_name}}_pagination_container">
      </nav>
    </div>
    <script>
    $(document).ready(function(){
      // init bootpag
      $('#{{ organizations_table.slugify_name }}_pagination_container').bootpag({
          total: {{ organizations_table.indexes|length }}
      }).on("page", function(event, num){ 
        horizon.ajax.queue({
          type: 'GET',
          url: '{% url 'fiware_complex_server_filters_organizations' %}',
          data: {
            page: num,
            application_id: '{{ application.id }}',
          },
          beforeSend: function () {
            // add a spinner to show progress
            var list_group = $("#{{ organizations_table.slugify_name }}").find('div.list-group');
            list_group.html('<i class="fa fa-gear fa-spin"></i>');
          },
          complete: function () {
          },
          error: function(jqXHR, status, errorThrown) {
          },
          success: function (data, textStatus, jqXHR) {
            var list_group = $("#{{ organizations_table.slugify_name }}").find('div.list-group');
            list_group.empty();
            for (var i in data) {
              var display_name = data[i]['username'];
              if (display_name === undefined) {
                display_name = data[i]['name'];
              }
              var avatar = data[i]['img_small'];
              var data_id = data[i]['id'];
              var description = data[i]['description'];

              list_group.append('<div class="list-group-item">' +
                '<a class="item" href="/idm/organizations/'+ data_id + '/">' +
                '<div class="avatar filter_field"><img src="'+ avatar + '"></div>'+
                '<div class="name filter_field">'+ display_name +'</div>' + 
                '<div class="description filter_field">'+ description +'</div></a></div>');
            }
          }
        });
      });
    });
  </script>
  </div>
</div>
{% endblock %}
